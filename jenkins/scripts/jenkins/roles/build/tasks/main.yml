---

# Get the secrets and remove the credential files

- name: Get the secret values from the credentials files
  set_fact:
    jenkins_admin_password: "{{ lookup('file', '/dev/shm/aws-devops/credentials/jenkins-admin-password') }}"
    aws_access_key_id: "{{ lookup('file', '/dev/shm/aws-devops/credentials/aws-access-key-id') }}"
    aws_secret_access_key: "{{ lookup('file', '/dev/shm/aws-devops/credentials/aws-secret-access-key') }}"

- name: Remove the credentials files
  file:
    path: "/dev/shm/aws-devops/"
    state: absent

# Start the server and wait intil is ready.

- name: Start the Jenkins service so the build can run
  service:
    name: jenkins
    enabled: yes
    state: started

- name: Wait until the Jenkins service is available
  uri:
    url: "http://localhost:8080/"
    return_content: yes
    status_code: [200, 403, 404]
  register: jenkins_wait
  until: jenkins_wait.status == 403 and jenkins_wait.content.find("Please wait while Jenkins is getting ready to work") == -1
  retries: 10
  delay: 5

# Store the AWS credentials and run the pipeline

- name: Get the Jenkins crumb. Required to post data to the Jenkins server.
  uri:
    url: http://localhost:8080/crumbIssuer/api/json
    force_basic_auth: yes
    user: admin
    password: "{{ jenkins_admin_password }}"
    return_content: yes
  register: jenkins_crumb

- name: Store the AWS credentials as a Jenkins secret
  uri:
    method: "POST"
    headers: '{"{{ jenkins_crumb.json.crumbRequestField }}":"{{ jenkins_crumb.json.crumb }}","Cookie":"{{ jenkins_crumb.set_cookie }}"}'
    url: "http://localhost:8080/credentials/store/system/domain/_/createCredentials"
    body_format: json
    body: >
      {
        "": "0",
        "credentials": {
          "scope": "GLOBAL",
          "id": "aws_credentials",
          "username": "{{ aws_access_key_id }}",
          "password": "{{ aws_secret_access_key }}",
          "description": "AWS Credentials",
          "$class": "com.cloudbees.plugins.credentials.impl.UsernamePasswordCredentialsImpl"
        }
      }
    force_basic_auth: yes
    user: admin
    password: "{{ jenkins_admin_password }}"
    status_code: [201]

- name: Run the pipeline build
  uri:
    method: "POST"
    headers: '{"{{ jenkins_crumb.json.crumbRequestField }}":"{{ jenkins_crumb.json.crumb }}","Cookie":"{{ jenkins_crumb.set_cookie }}"}'
    url: "http://localhost:8080/job/{{ jenkins_job_name }}/build"
    force_basic_auth: yes
    user: admin
    password: "{{ jenkins_admin_password }}"
    status_code: [201]