---

- name: Start the Jenkins service so the plugins can be installed
  service:
    name: jenkins
    enabled: yes
    state: started

- name: Wait until the Jenkins service is available
  uri:
    url: "http://127.0.0.1:8080/"
    return_content: yes
    status_code: 200, 403, 404
  register: jenkins_wait
  until: jenkins_wait.status == 403 and jenkins_wait.content.find('Please wait while Jenkins is getting ready to work') == -1
  retries: 10
  delay: 5

- name: Get Jenkins crumb
  uri:
    url: "http://127.0.0.1:8080/crumbIssuer/api/json"
    user: admin
    password: P4zzw0rd
    force_basic_auth: yes
    return_content: yes
    status_code: 200
  register: jenkins_crumb

- name: Build a job
  uri:
    method: "POST"
    headers:
      Jenkins-Crumb: "{{ jenkins_crumb.json.crumb }}"
      Cookie: "{{ jenkins_crumb.set_cookie }}"
    url: "http://127.0.0.1:8080/job/aws-devops/build"
    user: admin
    password: P4zzw0rd
    force_basic_auth: yes
    status_code: 203