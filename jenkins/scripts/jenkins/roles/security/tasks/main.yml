---
# Setup the Jenkins authorizationStrategy and securityRealm properties
# Then setup an admin user and password

- name: Copy the config.xml file to the jenkins folder
  copy:
    src: "config.xml"
    dest: "~jenkins/config.xml"
  register: jenkins_config_change

- name: Create a Jenkins admin password hash
  shell: echo -n "{{ jenkins_admin_password }}{ansible_jenkins}" | sha256sum - | awk '{ print $1; }'
  register: jenkins_password_hash

- name: Create the admin user directory
  file:
    path: "~jenkins/users/admin"
    owner: jenkins
    group: jenkins
    mode: "0755"
    recurse: yes
    state: directory

- name: Create the admin user configuration file
  template:
    src: "admin-config.xml.j2"
    dest: "~jenkins/users/admin/config.xml"
    force: no
  register: jenkins_admin_config

- name: Restart jenkins if necessary
  service:
    name: jenkins
    state: restarted
  when: jenkins_config_change.changed or jenkins_admin_config.changed

- name: Wait for Jenkins to become available
  wait_for:
    port: 8080